<!DOCTYPE html>
<html lang="it">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <!-- librerie bootstrap -->
   <script src="bootstrap-4.4.1-dist/js/popper.min.js"></script>
   <script src="bootstrap-4.4.1-dist/js/jquery-slim.min.js"></script>
   <script src="bootstrap-4.4.1-dist/js/bootstrap.min.js"></script>
   <link href="bootstrap-4.4.1-dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- development version, includes helpful console warnings -->
   <script src="vue/vue.js"></script>
   <!-- librerie jquery -->
   <script src="jquery/jquery.min.js"> </script>

   <!-- script e css nostri -->
   <link href="gestioneCorsi.css" rel="stylesheet">
   <title>
      Prenotazioni
   </title>
</head>
<body class="bg">
<div class="w-100 mx-0" >
   <!-- barra di navigazione -->
   <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand"><img src="img/logo4.png" width="25px" alt="Logo"/> Ripetizioni</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
         <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
         <ul class="navbar-nav mr-auto">
            <li class="nav-item">
               <a class="nav-link active" href="/progetto_ium_tweb2/Redirect?redirect=homepage">Home</a>
            </li>
            <li class="nav-item dropdown">
               <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Ripetizioni
               </a>
               <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="#">Prenota</a>
                  <a class="dropdown-item" href="#">Visualizza</a>
               </div>
            </li>

            <!-- Questa sezione sara visibile solo dagli amministratori -->
            <li class="nav-item">
               <a class="nav-link " href="#">Gestione corsi</a>
            </li>
            <li class="nav-item">
               <a class="nav-link " href="#" aria-selected="true" id="selected">Gestione docenti</a>
            </li>
            <li class="nav-item">
               <a class="nav-link " href="#">Visualizza tutte le prenotazioni</a>
            </li>
            <!-- fine sezione amministratori  -->
         </ul>

         <ul class="nav navbar-nav">
            <!-- Nome utente aggiunto dinamicamente -->
            <p class="navbar-text text-muted my-0 mr-2">Benvenuto, Utente </p>
            <li class="nav-item dropdown">
               <a class="nav-link dropdown-toggle" href="#" id="accountDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <img src="img/user.png" width="25px" alt="User logo"/>
               </a>
               <div class="dropdown-menu dropdown-menu-right" aria-labelledby="accountDropdownDropdown">
                  <a class="dropdown-item" href="#">Logout</a>
               </div>
            </li>
         </ul>
      </div>
      <!-- Fine sezione amministratore -->
   </nav>


   <!-- lista storico prenotazioni -->
   <div id="listStor" class="container-fluid card w-75 mx-auto mt-5">
      <table class="table table-striped">
         <thead>
            <tr>
               <th scope="col">Cognome Docente</th>
               <th scope="col">Nome Docente</th>
               <th scope="col">Corso</th>
               <th scope="col">Utente</th>
               <th scope="col">Giorno</th>
               <th scope="col">Ora</th>
               <th scope="col">Stato</th>
            </tr>
         </thead>
         <tbody>
         <tr v-for="(prenot, index) in prenotazioni">
            <td>{{prenot.docente.cognome}}</td>
            <td>{{prenot.docente.nome}}</td>
            <td>{{prenot.corso.titolo}}</td>
            <td>{{prenot.utente.account}}</td>
            <td>{{prenot.giorno}}</td>
            <td>{{prenot.slot}}</td>
            <td>
               <span v-if="prenot.stato!=='attiva'">{{prenot.stato}} </span>
               <select aria-label="StatoPrenotazione" v-else v-model="statoAggiornato[index]">
                  <option value="attiva" selected >Attiva</option>
                  <option value="effettuata">Effettuata</option>
                  <option value="disdetta">Disdetta</option>
               </select>
            </td>
         </tr>
         </tbody>
      </table>
      <button v-on:click="salvaPrenotazioni()" class="btn btn-success align-self-end" >Salva</button>
   </div>
   <script>
      var listStor = new Vue({
           el: '#listStor',
           data: {
               link: "/progetto_ium_tweb2/StoricoPrenotazioni",
               prenotazioni: [],
               statoAggiornato: [],
               risultato: true,
           },
           mounted() {
               this.getPrenot();
           },
           methods: {
               getPrenot: function () {
                   var self = this;
                   $.get(self.link, function(data) {
                       self.prenotazioni = data ;
                       for(var i=0; i<data.length; i++) {
                          self.statoAggiornato.push(data[i].stato);
                       }
                   });
               },
               salvaPrenotazioni: function () {
                  var thiz = this;
                  var oldPrenot= this.prenotazioni;
                  var newState = this.statoAggiornato;
                  for(var i=0; i<oldPrenot.length; i++) {
                     var oldState = oldPrenot[i].stato;
                     if(oldState !== newState[i]) {
                        $.post(
                           "/progetto_ium_tweb2/OpSuPrenotazioni",
                           {
                              op: (oldState === "effettuata" ? "effettuare" : "disdire"),
                              prenotazione: oldPrenot[i],
                           },
                           function (res) {
                              thiz.risultato = thiz.risultato && res;
                              if(res)
                                 oldPrenot[i].stato = newState[i];
                              if(i===oldPrenot.length-1) {
                                 if(thiz.risultato)
                                    window.alert("Operazione riuscita");
                                 else
                                    window.alert("operazione fallita!");
                              }
                           }
                        ); //end get
                     } //end if
                  } //end for

              } //end func
           }
       })
   </script>
</div>
</body>
</html>